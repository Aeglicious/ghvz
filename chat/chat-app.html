<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-dialog/paper-dialog.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-input/paper-input.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-button/paper-button.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-fab/paper-fab.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-input/paper-textarea.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/iron-flex-layout/iron-flex-layout-classes.html">

<!--
TODO(SquirrelThief):
- add "clear" button for dev to erase all chat messages
- wrap message display so messages don't go off screen
- autoscroll to bottom of chat
- set max dashlet height
- display user profile pic
- split into two modules, one for chat-room and one for chat-page
- add list of chat participants
- add list of available chat rooms + add new chat room
- display time of message
-->


<dom-module id="chat-app">
  <style include="iron-flex iron-flex-alignment">
    .message-from-other {
      justify-content: flex-start;
    }

    .message-from-me {
      justify-content: flex-end;
    }

    .my-name {
      padding-left: 8px;
      font-size: 10px;
    }

    .other-name {
      padding-right: 8px;
      font-size: 10px;
    }

    .display-message {
      white-space: pre;
    }

    .textbox {
      padding-top: 8px;
    }

    .textbox-input-field {
      @apply(--layout-flex);
    }
  </style>

  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
    	Polymer({
    		is: 'chat-app',

    		properties: {
          serverBridge: Object,

          gameId: String,

          currentPlayerId: String,

          chatRoomId: String,

          player: {
            type: Object,
            value: function() { return {}; },
          },

          chatRoom: {
            type: Object,
            value: function() { return {}; },
          },

          playerIds: {
            type: Array,
            value: function() { return []; },
          },
        },

        observers: [
        "chatRoomReady_(serverBridge, chatRoomId)",
        "currentPlayerIdReady_(serverBridge, currentPlayerId)",
        ],
        
        chatRoomReady_: function(serverBridge, chatRoomId) {
          serverBridge.getChatRoomById(chatRoomId)
          .then((chatRoom) => {
            this.chatRoom = chatRoom;
          });
        },

        currentPlayerIdReady_: function(serverBridge, currentPlayerId) {
          serverBridge.getPlayerById(currentPlayerId)
          .then((player) => {
            this.player = player;
          });
        },

        isMe_(senderId, myId) {
          return senderId === myId;
        },

        formatName_(messageObject) {
          if (messageObject.playerId === this.currentPlayerId) {
            return "message-from-me";
          } else {
            return "message-from-other";
          }
          return "";
        },

        /**
        * Sends messages to the server and retrieves any messages since last 
        * check. 
        */
        onSendClicked_: function() {
          if (!this.$.messageInput.value) {
            return;
          }

          this.serverBridge.addMessageToChatRoom(this.chatRoom.id, 
            this.player.id, this.$.messageInput.value);
          this.$.messageInput.value = "";  

          this.serverBridge.findMessagesForChatRoom(this.chatRoom.id, 0)
            .then((messages) => {
              this.set('chatRoom.messages', []);
              this.set('chatRoom.messages', messages);
              this.notifyPath('chatRoom.messages')
            });
        },

            /**
            * Submit text on 'enter', allow shift+enter to insert a new line in
            * the text field.
            */
            checkForEnter_: function(e) {
             if (e.keyCode === 13 && !e.shiftKey) {
              e.preventDefault();
              this.$.messageSend.click();
            }
          },
        });
    });
  </script>

  <template>
    <!-- Display messages -->
    <template is="dom-repeat" items="[[chatRoom.messages]]">
      <!-- Format message from me -->
      <template is="dom-if" if="[[isMe_(item.playerId, player.id)]]">
        <div class="layout horizontal message-from-me">
          <div class="display-message">[[item.message]]</div>
          <div class="my-name">[[item.playerId]]</div>
        </div> 
      </template>
      <!-- Format message from another player -->
      <template is="dom-if" if="[[!isMe_(item.playerId, player.id)]]">
        <div class="layout horizontal message-from-other">
          <div class="other-name">[[item.playerId]]</div>
          <div class="display-message">[[item.message]]</div>
        </div> 
      </template>
    </template>

    <!-- Text Input -->
    <div class="layout horizontal textbox">
      <paper-textarea 
      class="textbox-input-field"
      id="messageInput"
      autocorrect
      multiline
      max-rows=3
      label="message"
      no-label-float
      on-keydown="checkForEnter_">
    </paper-textarea>
    <paper-button
    class="flex-0"
    id="messageSend" 
    raised 
    style="background-color: #7e57c2; color: white" 
    on-click="onSendClicked_">
    ->
  </paper-button>
</div>

</template>
</dom-module>