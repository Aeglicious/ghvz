
<dom-module id="ghvz-guns">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-guns',

        properties: {
          serverBridge: Object,

          gameId: String,

          guns: Array,

          tableDelegate: {
            type: Object,
            value: function() {
              return {
                getSchema: (() => {
                  return [
                    {property: "gunNumber", name: "Number"},
                    {property: "player", name: "Player"},
                  ];
                }),
                getActions: (() => {
                  return [
                    //{action: "delete", name: "Delete"},
                  ];
                }),
                create: this.getTableContents_.bind(this),
                doAction: this.doTableAction_.bind(this),
              };
            },
          },
        },

        attached: function() {
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.refresh });
        },

        observers: [
          "ready_(serverBridge, gameId)",
        ],

        ready_: function(serverBridge, gameId) {
          this.refresh_();
        },

        doTableAction_: function(gun, action) {
        },

        addGun_: function() {
          this.serverBridge.addGun(Utils.generateId("gun"), this.newGunNumber);
          this.newGunNumber = "";
          this.refresh_();
        },

        getTableContents_: function(gun, propertyName) {
          if (propertyName == 'player') {
            var field = document.createElement('ghvz-player-field');
            field.serverBridge = this.serverBridge;
            field.gameId = this.gameId;
            field.playerIdOrNull = gun.playerIdOrNull;
            field.label = null;
            field.addEventListener('set-player', (e) => {
              let playerOrNull = e.detail.playerOrNull;
              this.serverBridge.setGunPlayer(gun.id, playerOrNull && playerOrNull.id);
              this.refresh_();
            });
            return field;
          }
        },

        refresh_: function() {
          this.serverBridge.getAllGuns()
              .then((guns) => {
                this.guns = guns;
              });
        },
      });
    });
  </script>
  <template>
    <style>
      #newGun {
        display: flex;
        margin: 8px;
      }

      #newGunNumber {
        flex: 1;
      }

      #addGunContainer {
        display: flex;
        align-items: center;
      }
    </style>

    <paper-icon-button
        id="refresh"
        icon="icons:refresh"
        on-tap="refresh_">
    </paper-icon-button>

    <ghvz-player-lookup-dialog
        server-bridge="[[serverBridge]]"
        game-id="[[gameId]]">
    </ghvz-player-lookup-dialog>

    <auto-table
        id="table"
        delegate="[[tableDelegate]]"
        items="[[guns]]">
    </auto-table>

    <div id="newGun">
      <paper-input
          id="newGunNumber"
          label="New gun's number"
          value="{{newGunNumber}}">
      </paper-input>
      <div id="addGunContainer">
        <paper-button
            id="addGun"
            raised
            disabled="[[!newGunNumber]]"
            on-tap="addGun_">
          Add Gun
        </paper-button>
      </div>
    </div>
  </template>
</dom-module>
