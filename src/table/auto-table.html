
<dom-module id="auto-table">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'auto-table',

        properties: {
          delegate: {
            type: Object,
            value: {},
          },

          items: {
            type: Array,
            value: function() { return []; },
          },

          hasActions: {
            type: Boolean,
            computed: 'computeHasActions_(delegate)',
          },

          selectable: {
            type: Boolean,
            value: false,
          },
        },

        computeHasActions_: function(delegate) {
          return delegate.getActions().length;
        },

        computeHasControlCell_: function(selectable, hasActions) {
          return selectable || hasActions;
        },

        getColumns_: function() {
          return this.delegate.getSchema();
        },

        getActions_: function() {
          return this.delegate.getActions();
        },

        getPropertyValue_: function(item, propertyName) {
          let value = this.delegate.create(item, propertyName);
          if (value === undefined)
            value = item[propertyName];
          return value;
        },

        getItemId_: function(item) {
          return item.id;
        },

        onBulkActionTapped_: function(e) {
          var matchingItems = [];
          var rows = this.$.tbody.querySelectorAll('tr');
          for (var i = 0; i < rows.length; i++) {
            if (this.getSelected_(i)) {
              matchingItems.push(this.items[i]);
            }
          }
          for (var i = 0; i < matchingItems.length; i++) {
            this.delegate.doAction(matchingItems[i], e.target.dataset.action);
          }
        },

        onActionTapped_: function(e) {
          this.delegate.doAction(this.getItemForId_(e.target.dataset.itemId), e.target.dataset.action);
        },

        getItemForId_: function(id) {
          for (var i = 0; i < this.items.length; i++) {
            if (this.getItemId_(this.items[i]) == id) {
              return this.items[i];
            }
          }
          console.error('Item not found for id:', id);
        },

        getIndexForId_: function(id) {
          for (var i = 0; i < this.items.length; i++) {
            if (this.getItemId_(this.items[i]) == id) {
              return i;
            }
          }
          console.error('Item index not found for id:', id);
        },

        onSelectChanged_: function(e) {
          var row = e.target.closest('tr');
          this.updateColor_(row, e.target.checked);

          if (this.$.selectAll.checked && !e.target.checked) {
            this.$.selectAll.checked = false;
          }
        },

        onSelectAllChanged_: function(e) {
          var rows = this.$.tbody.querySelectorAll('tr');
          for (var i = 0; i < rows.length; i++) {
            this.setSelected_(i, e.target.checked);
          }
        },

        getSelected_: function(index) {
          var row = this.$.tbody.querySelectorAll('tr')[index];
          return row.querySelector('paper-checkbox').checked;
        },

        setSelected_: function(index, selected) {
          var row = this.$.tbody.querySelectorAll('tr')[index];
          row.querySelector('paper-checkbox').checked = selected;
          this.updateColor_(row, selected);
        },

        updateColor_: function(row, selected) {
          if (selected)
            row.dataset.selected = "selected";
          else
            delete row.dataset.selected;
        },
      });
    });
  </script>
  <template>
    <style>
      :host {
        display: block;
      }
      #table {
        border-spacing: 0;
        font-size: 13pt;
        font-family: Roboto;
        font-weight: regular;
        color: rgba(0, 0, 0, .87);
        width: 100%;
        border-bottom: 1px solid #C0C0C0;
      }
      thead {
        background-color: #F0F0F0;
      }
      th {
        font-size: 12pt;
        font-weight: bold;
        text-align: left;
      }
      .property-header {
        color: rgba(0, 0, 0, .54);
      }
      tbody td {
        border-top: 1px solid #d8d8d8;
        border-bottom: 1px solid #f0f0f0;
      }
      th {
        border-bottom: 1px solid #f0f0f0;
      }
      th, td {
        padding: 0 16px;
        min-height: 40px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      td {
        @apply(--ghvz-auto-table-td);
      }
      .control-cell {
        padding: 0 0 0 16px;
      }
      .control-cell paper-menu-button {
        padding: 0;
      }
      tr[data-selected] {
        background-color: rgba(0, 0, 0, .1);
      }
      tr[data-selected] td {
        border-bottom: 1px solid #d8d8d8;
      }
      .property-header > div {
        min-height: 40px;
        display: flex;
        align-items: center;
      }
    </style>
    <table id="table">
      <thead>
        <tr id="headers">
          <template is="dom-if" if="[[computeHasControlCell_(selectable, hasActions)]]">
            <th class="control-cell">
              <template is="dom-if" if="[[selectable]]">
                <paper-checkbox id="selectAll" on-change="onSelectAllChanged_"></paper-checkbox>
              </template>
              <paper-menu-button>
                <paper-icon-button icon="menu" class="dropdown-trigger"></paper-icon-button>
                <paper-menu class="dropdown-content">
                  <template is="dom-repeat" items="[[getActions_(delegate)]]" as="action">
                    <paper-item on-tap="onBulkActionTapped_" data-action$="[[action.action]]">[[action.name]]</paper-item>
                  </template>
                </paper-menu>
              </paper-menu-button>
            </th>
          </template>
          <template is="dom-repeat" items="[[getColumns_(delegate)]]" as="column">
            <th class="property-header">
              <div>
                [[column.name]]
              </div>
            </th>
          </template>
        </tr>
      </thead>
      <tbody id="tbody">
        <template is="dom-repeat" items="[[items]]">
          <tr data-item-id$="[[getItemId_(item, delegate)]]">
            <template is="dom-if" if="[[computeHasControlCell_(selectable, hasActions)]]">
              <td class="control-cell">
                <template is="dom-if" if="[[selectable]]">
                  <paper-checkbox
                      data-item-id$="[[getItemId_(item, delegate)]]"
                      on-change="onSelectChanged_">
                  </paper-checkbox>
                </template>
                <template is="dom-if" if="[[hasActions]]">
                  <paper-menu-button>
                    <paper-icon-button icon="menu" class="dropdown-trigger"></paper-icon-button>
                    <paper-menu class="dropdown-content">
                      <template is="dom-repeat" items="[[getActions_(delegate)]]" as="action">
                        <paper-item on-tap="onActionTapped_" data-item-id$="[[getItemId_(item, delegate)]]" data-action$="[[action.action]]">[[action.name]]</paper-item>
                      </template>
                    </paper-menu>
                  </paper-menu-button>
                </template>
              </td>
            </template>
            <template is="dom-repeat" items="[[getColumns_(delegate)]]" as="column">
              <td>
                <ghvz-echo
                    value="[[getPropertyValue_(item, column.property, delegate)]]">
                </ghvz-echo>
              </td>
            </template>
          </tr>
        </template>
      </tbody>
    </table>
  </template>
</dom-module>
