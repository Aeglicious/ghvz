
<dom-module id="ghvz-missions">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-missions',

        properties: {
          serverBridge: Object,

          gameId: String,

          missions: Array,

          newMission: {
            type: Object,
            value: () => ({
              name: "",
              beginTime: "",
              endTime: "",
              url: "",
            }),
          },
        },

        makeTableBlueprint_: function() {
          return {
            columns: [
              {
                property: "name",
                name: "name"
              },
              {
                property: "beginTime",
                name: "Begin"
              },
              {
                property: "endTime",
                name: "End"
              },
              {
                property: "url",
                name: "Url"
              },
            ],
            actions: [
            ],
          };
        },

        attached: function() {
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.refresh });
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.add });
        },

        observers: [
          "ready_(serverBridge, gameId)",
        ],

        ready_: function(serverBridge, gameId) {
          this.refresh_();
        },

        refresh_: function() {
          this.serverBridge.findAllMissionsForGameId(this.gameId)
              .then((missions) => {
                this.missions = missions;
              });
        },

        addMission_: function() {
          this.serverBridge.addMission(
              Utils.generateId("mission"),
              this.gameId,
              this.newMission.beginTime,
              this.newMission.endTime,
              this.newMission.name,
              this.newMission.url);
          this.newMission = {
            name: "",
            beginTime: "",
            endTime: "",
            url: "",
          };
          this.refresh_();
        },

        computeAddMissionButtonEnabled_(newMissionName, newMissionBeginTime, newMissionEndTime, newMissionUrl) {
          return newMissionName && newMissionBeginTime && newMissionEndTime && newMissionUrl;
        },
      });
    });
  </script>
  <template>
    <style>
      paper-input {
        display: block;
        width: 100%;
        --paper-input-container-underline: {
          border-bottom-color: #C0C0C0;
        }
        margin-bottom: 4px;
      }
    </style>

    <paper-icon-button
        id="refresh"
        icon="icons:refresh"
        on-tap="refresh_">
    </paper-icon-button>

    <auto-table
        id="table"
        blueprint="[[makeTableBlueprint_()]]"
        items="[[missions]]">
    </auto-table>

    <ghvz-form
        id="add"
        title="Add Mission"
        open-icon="icons:add"
        close-label="Cancel"
        done-label="Add"
        done-enabled="[[computeAddMissionButtonEnabled_(newMission.name, newMission.beginTime, newMission.endTime, newMission.url)]]"
        on-ghvz-form-done="addMission_">
      <ghvz-form-section>
        <paper-input
            label="Mission name"
            value="{{newMission.name}}">
        </paper-input>
      </ghvz-form-section>
      <ghvz-form-section left description="(in seconds)">
        <paper-input
            label="Mission begin timestamp"
            value="{{newMission.beginTime}}">
        </paper-input>
      </ghvz-form-section>
      <ghvz-form-section right description="(in seconds)">
        <paper-input
            label="Mission end timestamp"
            value="{{newMission.endTime}}">
        </paper-input>
      </ghvz-form-section>
      <ghvz-form-section description="Url of the page describing the mission, example /firstgame/missions/first-mission.html">
        <paper-input
            label="Mission page url"
            value="{{newMission.url}}">
        </paper-input>
      </ghvz-form-section>
      <ghvz-form-section spaced>
        For timestamps, use <a href="https://www.epochconverter.com/">epochconverter</a>.
        Timestamps are in seconds, not milliseconds.
      </ghvz-form-section>
    </ghvz-form>
  </template>
</dom-module>
