
<dom-module id="ghvz-rewards">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-rewards',

        properties: {
          serverBridge: Object,

          gameId: String,

          game: Object,

          rewardCategoryId: {
            type: String,
            value: null,
            observer: 'refreshRewardsTable_',
          },

          rewards: {
            type: Array,
            value: () => [],
          },

          playersById: {
            type: Object,
            value: () => new Map(),
          },
        },

        attached: function() {
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.refresh });
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.add });
        },

        observers: [
          "ready_(serverBridge, gameId)",
        ],

        ready_: function(serverBridge, gameId) {
          this.refresh_();
        },

        makeCategoriesTableBlueprint_: function() {
          return {
            columns: [
              {
                property: "name",
                name: "Name",
              },
              {
                property: "points",
                name: "Points",
              },
              {
                property: "seed",
                name: "Seed",
              },
              {
                property: "claimed",
                name: "Claimed",
                getModel: (category) => category.claimed + '/' + category.total,
              },
            ],
            actions: [
              {
                name: "Show Rewards",
                handler: (category) => this.rewardCategoryId = category.id,
              },
              {
                name: "Edit",
                handler: this.startEditingCategory_.bind(this),
              },
            ],
          };
        },

        makeRewardsTableBlueprint_: function() {
          return {
            columns: [
              {
                property: "rewardCode",
                name: "Code",
                sortable: true,
                filterable: true,
              },
              {
                property: "claimer",
                name: "Claimer",
                getModel: (reward) => {
                  if (reward.playerIdOrNull == null) {
                    return "(unclaimed)";
                  } else {
                    var player = this.playersById.get(reward.playerIdOrNull);
                    return player ? player.name : "(unknown!)";
                  }
                },
              },
            ],
            actions: [
              {
                action: "delete",
                name: "Delete"
              },
            ]
          };
        },

        makeCategoryFormBlueprint_: function() {
          return {
            fields: [
              {
                property: "name",
                label: "Name",
                description: "Title of the category. Users will see this next to the icon in their profile and when they hover over the icon.",
              },
              {
                property: "points",
                type: "number",
                label: "Name",
                left: true,
                description: "Num points gained by claiming one of this category's rewards. 0 is a valid value (for example for vaccines).",
              },
              {
                property: "seed",
                label: "Seed",
                right: true,
                description: "A word to prefix codes with. Must be unique. Also used as a random seed for generating the codes. Example: derp.",
              },
            ],
          };
        },

        refresh_: function() {
          this.serverBridge.getGameById(this.gameId)
              .then((game) => {
                this.game = game;
              })
          this.serverBridge.findAllPlayersForGameId(this.gameId)
              .then((players) => {
                this.playersById = new Map();
                for (let player of players)
                  this.playersById.set(player.id, player);
              });
          this.refreshRewardsTable_();
        },

        refreshRewardsTable_: function() {
          if (this.rewardCategoryId) {
            this.serverBridge.findRewardsForRewardCategoryId(this.rewardCategoryId)
                .then((rewards) => {
                  this.rewards = rewards;
                });
          }
        },

        addRewards_: function() {
          this.serverBridge.addRewards(this.rewardCategoryId, this.numNewRewards);
          this.numNewRewards = "";
          this.refreshRewardsTable_();
        },

        startAddingCategory_: function() {
          this.$.categoryForm.openForAdding()
              .then((category) => {
                this.serverBridge.addRewardCategory(
                    Utils.generateId("rewardCategory"),
                    this.gameId,
                    category.name,
                    category.points,
                    category.seed);
                this.refresh_();
              });
        },

        startEditingCategory_: function(category) {
          this.$.categoryForm.openForEditing(
              category.id,
              {
                name: category.name,
                points: category.points,
                seed: category.seed,
              })
              .then((newProperties) => {
                this.serverBridge.updateRewardCategory(
                    category.id,
                    newProperties);
                this.refresh_();
              });
        },
      });
    });
  </script>
  <template>
    <style>
      paper-input {
        --paper-input-container: {
          padding: 0;
        }
      }
      #rewards {
        margin-top: 16px;
      }
      #rewardsTable {
      }
      #rewardCodeInput {
        flex: 1;
        margin: 0 8px;
      }
      .wide-input-row {
        margin: 0 8px;
      }
      .input-row {
        display: flex;
      }
      .input-row paper-input {
        min-width: 100px;
      }
      .input-description {
        display: flex;
        align-items: flex-end;
      }
      #addReward {
        margin: 8px;
        white-space: nowrap;
      }
      .input-row paper-input {
        margin: 0 8px;
      }

      #newReward {
        display: flex;
      }
      #addRewardContainer {
        display: flex;
        align-items: flex-end;
      }
    </style>
    <paper-icon-button id="refresh" icon="icons:refresh" on-tap="refresh_">
    </paper-icon-button>
    <paper-icon-button id="add" icon="icons:add" on-tap="startAddingCategory_">
    </paper-icon-button>

    <auto-table
        id="categoriesTable"
        blueprint="[[makeCategoriesTableBlueprint_()]]"
        items="[[game.rewardCategories]]">
    </auto-table>

    <ghvz-super-form
        id="categoryForm"
        type-name="Reward Category"
        blueprint="[[makeCategoryFormBlueprint_()]]"
        on-ghvz-super-form-done-adding="doneAddingCategory_"
        on-ghvz-super-form-done-editing="doneEditingCategory_">
    </ghvz-super-form>

    <div id="rewards" hidden="[[!rewardCategoryId]]">
      <div id="newReward">
        <paper-input
            id="rewardCodeInput"
            label="Num rewards to generate"
            value="{{numNewRewards}}">
        </paper-input>
        <div id="addRewardContainer">
          <paper-button
              id="addReward"
              raised
              disabled="[[!numNewRewards]]"
              on-tap="addRewards_">
            Add Rewards
          </paper-button>
        </div>
      </div>

      <auto-table
          id="rewardsTable"
          blueprint="[[makeRewardsTableBlueprint_()]]"
          items="[[rewards]]">
      </auto-table>
    </div>
  </template>
</dom-module>
