
<dom-module id="ghvz-rewards">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-rewards',

        properties: {
          serverBridge: Object,

          gameId: String,

          game: Object,

          rewardCategoryId: {
            type: String,
            value: null,
            observer: 'refreshRewardsTable_',
          },

          rewards: {
            type: Array,
            value: () => [],
          },

          playersById: {
            type: Object,
            value: () => new Map(),
          },

          newRewardCode: {
            type: String,
            value: "",
          },

          newCategoryName: {
            type: String,
            value: "",
          },

          newCategoryPoints: {
            type: String,
            value: "",
          },

          categoriesTableDelegate: {
            type: Object,
            value: function() {
              return {
                getSchema: (() => {
                  return [
                    {property: "name", name: "Name"},
                    {property: "points", name: "Points"},
                    {property: "total", name: "# Total"},
                    {property: "claimed", name: "# Claimed"},
                  ];
                }),
                getActions: (() => {
                  return [
                    {action: "show", name: "Show Rewards"},
                    {action: "setpoints", name: "Set Points"},
                    {action: "setname", name: "Set Name"},
                  ];
                }),
                create: this.getCategoriesTableContents_.bind(this),
                update: this.getCategoriesTableContents_.bind(this),
                doAction: this.doCategoriesTableAction_.bind(this),
              };
            },
          },

          rewardsTableDelegate: {
            type: Object,
            value: function() {
              return {
                getSchema: (() => {
                  return [
                    {property: "rewardCode", name: "Code"},
                    {property: "claimer", name: "Claimer"},
                  ];
                }),
                getActions: (() => {
                  return [
                    {action: "delete", name: "Delete"},
                  ];
                }),
                create: this.getRewardsTableContents_.bind(this),
                update: this.getRewardsTableContents_.bind(this),
                doAction: this.doRewardsTableAction_.bind(this),
              };
            },
          },
        },

        attached: function() {
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.refresh });
        },

        observers: [
          "ready_(serverBridge, gameId)",
        ],

        ready_: function(serverBridge, gameId) {
          this.refresh_();
        },

        doCategoriesTableAction_: function(category, action) {
          if (action == 'show') {
            this.rewardCategoryId = category.id;
          }
        },

        doRewardsTableAction_: function(player, action) {
        },

        getCategoriesTableContents_: function(category, propertyName) {
        },

        getRewardsTableContents_: function(reward, propertyName) {
          if (propertyName == 'claimer') {
            if (reward.playerIdOrNull == null) {
              return "(unclaimed)";
            } else {
              var player = this.playersById.get(reward.playerIdOrNull);
              return player ? player.name : "(unknown!)";
            }
          }
        },

        refresh_: function() {
          this.serverBridge.getGameById(this.gameId)
              .then((game) => {
                this.game = game;
              })
          this.serverBridge.findAllPlayersForGameId(this.gameId)
              .then((players) => {
                this.playersById = new Map();
                for (let player of players)
                  this.playersById.set(player.id, player);
              });
          this.refreshRewardsTable_();
        },

        refreshRewardsTable_: function() {
          if (this.rewardCategoryId) {
            this.serverBridge.findRewardsForRewardCategoryId(this.rewardCategoryId)
                .then((rewards) => {
                  this.rewards = rewards;
                });
          }
        },

        addCategory_: function() {
          this.serverBridge.addRewardCategory(
              Utils.generateId("rewardCategory"), this.newCategoryName, this.newCategoryPoints);
          this.newCategoryName = "";
          this.newCategoryPoints = "";
          this.refresh_();
        },

        addReward_: function() {
          this.serverBridge.addReward(
              Utils.generateId("reward"), this.rewardCategoryId, this.newRewardCode);
          this.newRewardCode = "";
          this.refreshRewardsTable_();
        },
      });
    });
  </script>
  <template>
    <style>
      #rewards {
        margin-top: 16px;
      }
      #rewardsTable {
      }
      #newReward,
      #newCategory {
        display: flex;
      }
      #rewardCodeInput {
        flex: 1;
        margin: 0 8px;
      }
      #addRewardContainer,
      #addCategoryContainer {
        flex: 0;
        display: flex;
        align-items: flex-end;
      }
      #addReward,
      #addCategory {
        margin: 8px;
        white-space: nowrap;
      }
      #categoryNameInput {
        flex-grow: 2;
        margin: 0 8px;
      }
      #categoryPointsInput {
        flex-grow: 1;
        margin: 0 8px;
      }
    </style>
    <paper-icon-button
        id="refresh"
        icon="icons:refresh"
        on-tap="refresh_">
    </paper-icon-button>

    <div id="categories">
      <auto-table
          id="categoriesTable"
          delegate="[[categoriesTableDelegate]]"
          items="[[game.rewardCategories]]">
      </auto-table>
      <div id="newCategory">
        <paper-input
            id="categoryNameInput"
            label="Name"
            value="{{newCategoryName}}">
        </paper-input>
        <paper-input
            id="categoryPointsInput"
            label="Points"
            value="{{newCategoryPoints}}">
        </paper-input>
        <div id="addCategoryContainer">
          <paper-button
              id="addCategory"
              raised
              disabled="[[!newCategoryName]]"
              on-tap="addCategory_">
            Add Category
          </paper-button>
        </div>
      </div>
    </div>

    <div id="rewards" hidden="[[!rewardCategoryId]]">
      <div id="newReward">
        <paper-input
            id="rewardCodeInput"
            label="Code"
            value="{{newRewardCode}}">
        </paper-input>
        <div id="addRewardContainer">
          <paper-button
              id="addReward"
              raised
              disabled="[[!newRewardCode]]"
              on-tap="addReward_">
            Add Reward
          </paper-button>
        </div>
      </div>

      <auto-table
          id="rewardsTable"
          delegate="[[rewardsTableDelegate]]"
          items="[[rewards]]">
      </auto-table>
    </div>
  </template>
</dom-module>
