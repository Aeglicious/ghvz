
<dom-module id="desktop-app">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'desktop-app',

        properties: {
          serverBridge: {
            type: Object,
            value: makeFakePrepopulatedServerBridge(),
          },

          chatRoomIds: {
            type: Array,
            value: undefined,
          },

          gameId: {
            type: String,
            value: undefined,
          },

          userId: {
            type: String,
            value: undefined,
          },

          playerId: {
            type: String,
            value: undefined,
          },
        },

        attached: function() {
          this.serverBridge.logIn('firstuserauthcode')
              .then((userId) => {
                this.userId = userId;
                return this.serverBridge.findAllPlayerIdsForUserId(this.userId);
              })
              .then((playerIds) => {
                if (playerIds.length == 0) {
                  alert('you should join a game');
                } else if (playerIds.length == 1) {
                  this.playerId = playerIds[0];
                  this.serverBridge.findAllChatRoomIdsForPlayerId(this.playerId)
                      .then((chatRoomIds) => {
                        this.chatRoomIds = chatRoomIds;
                      });
                  this.serverBridge.getPlayerById(this.playerId)
                      .then((player) => {
                        this.gameId = player.gameId;
                      });
                } else {
                  alert('you should somehow choose a game');
                }
              });
        },
      });
    });
  </script>
  <template>
  	<style>
      .content {
        display: block;
        margin: 16px;
      }
  	</style>

    <ghvz-dashboard>
      <ghvz-dashlet full>
        <div class="header">Players</div>
        <player-table
            id="playerTableModule"
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]"
            current-user-id="[[userId]]">
        </player-table>
      </ghvz-dashlet>
      
      <ghvz-dashlet half left>
        <div class="header">Dev Tools</div>
        <dev-tools
            class="content"
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]"
            user-id="[[userId]]">
        </dev-tools>
      </ghvz-dashlet>

      <ghvz-dashlet half left>
        <div class="header">Infect</div>
        <ghvz-infect
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]"
            player-id="[[playerId]]">
        </ghvz-infect>
      </ghvz-dashlet>

      <ghvz-dashlet half left>
        <div class="header">Rewards</div>
        <ghvz-claim-reward
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]"
            player-id="[[playerId]]">
        </ghvz-next-mission>
      </ghvz-dashlet>

      <ghvz-dashlet padded half left>
        <div class="header">Next Mission</div>
        <ghvz-next-mission
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]"
            player-id="[[playerId]]">
        </ghvz-next-mission>
      </ghvz-dashlet>

      <ghvz-dashlet half right>
        <div class="header">Leaderboard</div>
        <leaderboard-summary
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]">
        </leaderboard-summary>
      </ghvz-dashlet>

      <template is="dom-repeat" items="[[chatRoomIds]]" as="chatRoomId">
        <ghvz-dashlet half right>
          <div class="header">[[chatRoom.name]]</div>
          <chat-app
              class="content"
              server-bridge="[[serverBridge]]"
              game-id="[[gameId]]"
              current-player-id="[[playerId]]"
              chat-room-id="[[chatRoomId]]">
          </chat-app>
        </ghvz-dashlet>
      </template>

      <ghvz-dashlet half left>
        <div class="header">Game Stats</div>
        <game-stat-summary class="content">
        </game-stat-summary>
      </ghvz-dashlet>

      <ghvz-dashlet half right>
        <div class="header">Join A Game</div>
        <game-registration
              class="content"
              server-bridge="[[serverBridge]]"
              game-id="[[gameId]]"
              user-id="[[userId]]">
        </game-registration>
      </ghvz-dashlet>

    </ghvz-dashboard>

  </template>
</dom-module>
