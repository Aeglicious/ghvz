
<dom-module id="desktop-app">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'desktop-app',

        properties: {
          serverBridge: {
            type: Object,
            value: makeFakePrepopulatedServerBridge(),
          },

          chatRoomIds: {
            type: Array,
            value: undefined,
          },

          gameId: {
            type: String,
            value: undefined,
          },

          userId: {
            type: String,
            value: undefined,
          },

          playerId: {
            type: String,
            value: undefined,
          },

          isAdmin: {
            type: Boolean,
            value: false,
          },
        },

        attached: function() {
          this.serverBridge.logIn('firstuserauthcode')
              .then((userId) => {
                this.userId = userId;
                return this.serverBridge.findAllPlayerIdsForUserId(this.userId);
              })
              .then((playerIds) => {
                if (playerIds.length == 0) {
                  alert('you should join a game');
                } else if (playerIds.length == 1) {
                  this.playerId = playerIds[0];
                  this.serverBridge.findAllChatRoomIdsForPlayerId(this.playerId)
                      .then((chatRoomIds) => {
                        this.chatRoomIds = chatRoomIds;
                      });
                  this.serverBridge.getPlayerById(this.playerId)
                      .then((player) => {
                        this.gameId = player.gameId;
                      });
                } else {
                  alert('you should somehow choose a game');
                }
              });
        },

        becomeAdmin_: function() {
          this.isAdmin = true;
        },

        becomeNotAdmin_: function() {
          this.isAdmin = false;
        },
      });
    });
  </script>
  <template>
  	<style>
      .content {
        display: block;
        margin: 16px;
      }
      #admin paper-button {
        background-color: #03A9F4;
        color: white;
      }
  	</style>

    DONT POST CONFIDENTIAL INFO, COBFLABBIT!
    <div id="admin">
      <paper-button on-tap="becomeAdmin_" hidden$="[[isAdmin]]">
        Become Admin
      </paper-button>
      <paper-button on-tap="becomeNotAdmin_" hidden$="[[!isAdmin]]">
        Become Regular Player
      </paper-button>
    </div>

    <ghvz-dashboard>
      <template is="dom-if" if="[[isAdmin]]">
        <ghvz-dashlet admin full>
          <div class="header">Players</div>
          <player-table
              id="playerTableModule"
              server-bridge="[[serverBridge]]"
              game-id="[[gameId]]"
              current-user-id="[[userId]]">
          </player-table>
        </ghvz-dashlet>
        
        <ghvz-dashlet admin half left>
          <div class="header">Dev Tools</div>
          <dev-tools
              class="content"
              server-bridge="[[serverBridge]]"
              game-id="[[gameId]]"
              user-id="[[userId]]">
          </dev-tools>
        </ghvz-dashlet>

        <ghvz-dashlet admin half right>
          <div class="header">Guns</div>
          <ghvz-guns
              server-bridge="[[serverBridge]]"
              game-id="[[gameId]]">
          </ghvz-guns>
        </ghvz-dashlet>

        <ghvz-dashlet admin half right>
          <div class="header">Rewards</div>
          <ghvz-rewards
              server-bridge="[[serverBridge]]"
              game-id="[[gameId]]">
          </ghvz-rewards>
        </ghvz-dashlet>
      </template>

      <ghvz-dashlet padded half left>
        <div class="header">Next Mission</div>
        <ghvz-next-mission
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]"
            player-id="[[playerId]]">
        </ghvz-next-mission>
      </ghvz-dashlet>

      <ghvz-dashlet half right>
        <div class="header">Leaderboard</div>
        <leaderboard-summary
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]">
        </leaderboard-summary>
      </ghvz-dashlet>

      <ghvz-dashlet half left>
        <div class="header">Game Stats</div>
        <game-stat-summary>
        </game-stat-summary>
      </ghvz-dashlet>

      <ghvz-dashlet half left>
        <div class="header">Infect</div>
        <ghvz-infect
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]"
            player-id="[[playerId]]">
        </ghvz-infect>
      </ghvz-dashlet>

      <ghvz-dashlet half left>
        <div class="header">Rewards</div>
        <ghvz-claim-reward
            server-bridge="[[serverBridge]]"
            game-id="[[gameId]]"
            player-id="[[playerId]]">
        </ghvz-next-mission>
      </ghvz-dashlet>

      <template is="dom-repeat" items="[[chatRoomIds]]" as="chatRoomId">
        <ghvz-dashlet half right>
          <div class="header">[[chatRoom.name]]</div>
          <chat-app
              class="content"
              server-bridge="[[serverBridge]]"
              game-id="[[gameId]]"
              current-player-id="[[playerId]]"
              chat-room-id="[[chatRoomId]]">
          </chat-app>
        </ghvz-dashlet>
      </template>

      <template is="dom-if" if="[[isRegistering]]">
        <ghvz-dashlet half right>
          <div class="header">Join A Game</div>
          <game-registration
                class="content"
                server-bridge="[[serverBridge]]"
                game-id="[[gameId]]"
                user-id="[[userId]]">
          </game-registration>
        </ghvz-dashlet>
      </template>

    </ghvz-dashboard>

  </template>
</dom-module>

<style>
  /* whoever designed the default paper-menu needs to be shot */
  desktop-app paper-menu {
    padding: 0 !important;
  }
  desktop-app paper-menu .iron-selected {
    font-weight: inherit !important;
  }
  desktop-app paper-menu paper-item {
    min-height: 36px !important;
    white-space: nowrap;
  }
  desktop-app paper-menu paper-item::before,
  desktop-app paper-menu paper-item::after {
    display: none;
  }
  desktop-app paper-menu paper-item:hover {
    background-color: #F0F0F0 !important;
    cursor: pointer;
  }

  paper-input-container {
    padding: 0 !important;
  }
</style>
