
<dom-module id="ghvz-mobile-app">
<script>
  // Not sure why this HTMLImports.whenReady is really needed.
  // Something about polymer initialization order.
  // I think we're not supposed to need this.
  HTMLImports.whenReady(() => {
    Polymer({
      is: 'ghvz-mobile-app',

      properties: {
        bridge: Object,
        database: Object,
        userId: String,
        gameId: String,
        playerId: String,
        page: {
          type: String,
          observer: 'onPageChanged_',
        },

        secondPage: {
          type: String,
          value: null,
        },

        canInfect: {
          type: Boolean,
          computed: 'computeCanInfect_(playerId, database.game, database.game.playersById.*)',
        },

        canRegister: {
          type: Boolean,
          computed: 'computeCanRegister_(gameId, playerId)',
        },

        isPlayer: {
          type: Boolean,
          computed: 'computeIsPlayer_(playerId)',
        },
        
        isAdmin: {
          type: Boolean,
          computed: 'computeIsAdmin_(userId, database.game, database.game.admins.*)',
        },
      },

      listeners: {
        'ghvz-open-drawer': 'openDrawer_',
        'ghvz-close-drawer': 'closeDrawer_',
      },

      attached() {
      },

      computeCanInfect_: function(playerId, game) {
        return game.playersById[playerId] && !game.playersById[playerId].infectable;
      },

      computeCanRegister_(gameId, playerId) {
        return gameId && !playerId;
      },

      computeIsPlayer_(playerId) {
        return !!playerId;
      },

      computeIsAdmin_: function(userId, game) {
        let admin = game.admins.find((admin) => admin.userId == userId);
        return !!admin;
      },

      openDrawer_() {
        this.$.drawer.openDrawer();
      },

      closeDrawer_() {
        this.$.drawer.closeDrawer();
      },

      onPageChanged_: function(newPage, oldPage) {
        if (newPage == 'main') {
          this.$.pages.entryAnimation = '';
          this.$.pages.exitAnimation = '';
          this.$.pages.selected = 0;
        } else {
          this.secondPage = newPage;
          this.$.pages.entryAnimation = 'slide-from-right-animation';
          this.$.pages.exitAnimation = '';
          this.$.pages.selected = 1;
        }
      },

      statsPageVisible_(secondPage) { return secondPage == 'stats'; }
    });
  });
</script>
<style>
  :host {
    width: 100%;
    height: 100%;
  }
  neon-animated-pages {
    width: 100%;
    height: 100%;
  }
  neon-animatable {
    width: 100%;
    height: 100%;
    background-color: white;
  }
  ghvz-game-selector {
    margin: 0 12px 8px;
  }
</style>
<template>
  <paper-drawer-panel id="drawer" disable-swipe>
    <div id="drawer" drawer>
      <ghvz-mobile-drawer
          bridge="[[bridge]]"
          database="[[database]]"
          user-id="[[userId]]"
          game-id="[[gameId]]"
          player-id="[[playerId]]"
          can-infect="[[canInfect]]"
          can-register="[[canRegister]]"
          is-player="[[isPlayer]]"
          is-admin="[[isAdmin]]">
      </ghvz-mobile-drawer>
    </div>
    <div main>
      <neon-animated-pages id="pages" class="flex" selected="0">
        <neon-animatable>
          <ghvz-mobile-main-page
              bridge="[[bridge]]"
              database="[[database]]"
              user-id="[[userId]]"
              game-id="[[gameId]]"
              player-id="[[playerId]]"
              can-infect="[[canInfect]]"
              can-register="[[canRegister]]"
              is-player="[[isPlayer]]">
          </ghvz-mobile-main-page>
        </neon-animatable>
        <neon-animatable>
          <template is="dom-if" if="[[secondPage]]">
            <template is="dom-if" if="[[statsPageVisible_(secondPage)]]">
              <ghvz-dashlet full expand with-menu>
                <div class="header">Game Stats</div>
                <ghvz-stats-page
                    bridge="[[bridge]]"
                    database="[[database]]"
                    game-id="[[gameId]]"
                    user-id="[[userId]]"
                    player-id="[[playerId]]">
                </ghvz-stats-page>
              </ghvz-dashlet>
            </template>
          </template>
        </neon-animatable>
      </neon-animated-pages>

    </div>
  </paper-drawer-panel>

</template>
</dom-module>
