<dom-module id="ghvz-order-question">
<script>
  // Not sure why this HTMLImports.whenReady is really needed.
  // Something about polymer initialization order.
  // I think we're not supposed to need this.
  HTMLImports.whenReady(() => {
    Polymer({
      is: 'ghvz-order-question',

      properties: {
        question: {
          type: String,
          observer: 'reset_',
        },

        answers: {
          type: Array,
          value: () => [],
        },

        nextEnabled: {
          type: Boolean,
          value: false,
        },
      },

      onAnswerTapped_(e) {
        let unorderedAnswer = e.target.closest('.answer');
        let answerId = unorderedAnswer.dataset.answerId;
        let orderedAnswer =
            Array.from(this.querySelectorAll('#ordered .answer'))
                .find(answer => answer.dataset.answerId == answerId);
        assert(orderedAnswer);
        unorderedAnswer.opened = false;
        // Move it to the end
        orderedAnswer.parentNode.appendChild(orderedAnswer);
        orderedAnswer.opened = true;
        this.updateNextEnabled_();
      },

      updateNextEnabled_() {
        this.nextEnabled = this.isCorrect_();
      },

      isCorrect_() {
        let answers = this.querySelectorAll("#ordered .answer");
        if (answers != this.answers.length) {
          return false;
        }
        for (let i = 0; i < answers.length; i++) {
          let answer = answers[i];
          let originalIndex = this.$.repeater.indexForElement(answer);
          if (originalIndex != i) {
            return false;
          }
        }
        return true;
      },

      confirm_: function(event) {
        this.fire('ghvz-order-question-confirm');
      },

      reset_: function(event) {
        this.answers = Utils.shuffle(this.question.answers.slice());
        this.updateNextEnabled_();
      },
    });
  });
</script>
<style>
  :host {
    display: block;
  }
  #answers {
    display: flex;
    flex-direction: row;
  }
  #unordered {
    width: 50%;
  }
  #ordered {
    width: 50%;
  }
  .answer {
    margin: 8px 0
  }
  .answer paper-material {
    padding: 8px;;
    display: flex;
    flex-direction: row;
  }
  .text {
    flex-grow: 1;
    display: flex;
    align-items: center;
  }
  paper-button {
    background-color: #03A9F4;
    color: white;
  }
</style>
<template>
  <div>
    [[question.text]]
  </div>
  <div id="answers">
    <div id="unordered">
      <template id="repeater" is="dom-repeat" items="[[answers]]" as="answer">
        <iron-collapse class="answer" opened data-answer-id$="[[answer.id]]">
          <paper-material>
            <div class="text">
              [[answer.text]]
            </div>
            <div class="button-container">
              <paper-button raised on-tap="onAnswerTapped_">Choose</paper-button>
            </div>
          </paper-material>
        </iron-collapse>
      </template>
    </div>
    <div id="ordered">
      <template id="repeater" is="dom-repeat" items="[[question.answers]]" as="answer">
        <iron-collapse class="answer" data-answer-id$="[[answer.id]]">
          <paper-material>
            <!-- <div class="text"> -->
              [[answer.text]]
            <!-- </div>
            <paper-button raised on-tap="onAnswerTapped_">Choose</paper-button> -->
          </paper-material>
        </iron-collapse>
      </template>
    </div>
  </div>
  <div>
    <paper-button on-tap="reset_">Reset</paper-button>
    <paper-button on-tap="confirm_" disabled="[[!nextEnabled]]">Next</paper-button>
  </div>
</template>
</dom-module>