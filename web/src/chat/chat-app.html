
<!--
TODO(SquirrelThief):
- add "clear" button for dev to erase all chat messages
- wrap message display so messages don't go off screen
- autoscroll to bottom of chat
- display user profile pic
- split into two modules, one for chat-room and one for chat-page
- add list of chat participants
- add list of available chat rooms
- create a new chat room
- display time of message
-->


<dom-module id="chat-app">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
    	Polymer({
    		is: 'chat-app',

    		properties: {
          bridge: Object,

          gameId: String,

          currentPlayerId: String,

          playersById: Object,

          player: {
            type: Object,
            value: function() { return {}; },
          },

          chatRoom: {
            type: Object,
            value: function() { return {}; },
          },

          previousMessagePlayerId: {
            type: String,
            value: "",
          },

          pollInterval: {
            type: Number,
            value: 1,  // in seconds
          },
        },

        attached: function() {
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.refresh });
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.add });
        },

        pollMessages_: function() {
          var afterId = this.chatRoom.messages.slice(-1)[0].id;
          this.bridge.findMessagesForChatRoom(this.chatRoom.id, afterId)
          .then((messages) => {
            var afterId = this.chatRoom.messages.slice(-1)[0].id;
            for (var index in messages) {
              if(messages[index].id > afterId) {
                this.push('chatRoom.messages', messages[index]);
              }
            }
          });
        },

        /*setShowNameOnMessage_: function(messages) {
          if (!messages) { return []; }
          var processed = [];
          var previousPlayerId = "";
          for (var i = 0; i < messages.length; i++) {
            processed.push(messages[i]);
            processed[i].showName = false;
            if (processed[i].playerId != previousPlayerId) {
              previousPlayerId = processed[i].playerId;
              var previousIndex = Math.max(i - 1, 0);
              processed[previousIndex].showName = true;
            }
            if (i == messages.length - 1) {
              processed[i].showName = true;
            }
          }
          return processed;
        },*/

        computeMessageDisplayClass_(senderId, myId) {
          return senderId === myId ? 'message-from-me' : 'message-from-other';
        },

        /**
        * Sends messages to the server and retrieves any messages since last 
        * check. 
        */
        onSendClicked_: function() {
          if (!this.$.messageInput.value) {
            return;
          }
          this.bridge.addMessageToChatRoom(this.chatRoom.id, 
            this.playerId, this.$.messageInput.value);
          this.$.messageInput.value = "";  

          var afterId = this.chatRoom.messages.slice(-1)[0].id;

          this.bridge.findMessagesForChatRoom(this.chatRoom.id, afterId)
          .then((messages) => {
            var afterId = this.chatRoom.messages.slice(-1)[0].id;
            for (var index in messages) {
              if(messages[index].id > afterId) {
                this.push('chatRoom.messages', messages[index]);
              }
            }
          });
        },

        /**
        * Submit text on 'enter', allow shift+enter to insert a new line in
        * the text field.
        */
        checkForEnter_: function(e) {
         if (e.keyCode === 13 && !e.shiftKey) {
          e.preventDefault();
          this.$.messageSend.click();
        }
      },

      displaySenderInfo(playerId) {
        if (playerId != this.previousMessagePlayerId) {
          this.previousMessagePlayerId = playerId;
          return 'display-sender';
        } else {
          return 'hide-sender';
        }
      },

      getName_(playerId) {
        if (!this.playersById[playerId]) {
          this.bridge.getPlayerById(playerId)
          .then((player) => {
            this.playersById[playerId] = player;
            return this.playersById[playerId].name;
          });
        } else {
          return this.playersById[playerId].name;
        }
      },

      getProfilePic_(playerId) {
        var imageUrl = this.playersById[playerId].profileImageUrl;
        return imageUrl;
      },

      openPlayerProfile_(e) {
        console.log(e);
      },

      /**
      * Returns the date in format: Day 00:00
      */
      getTime_(time) {
        var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        var date = new Date(time);
        return days[date.getDay()] + " " + 
        ("0" + date.getHours()).slice(-2) + ":" + 
        ("0" + date.getMinutes()).slice(-2);
      },

      refresh_: function() {
        this.pollMessages_();
      },

      addPlayer_: function() {
        this.$.addPlayerForm.openForAdding()
        .then((properties) => {
          console.log(properties);
                //this.bridge.addGun(Utils.generateId("gun"), properties);
                //this.refresh_();
              });
      },

      makeFormBlueprint_: function() {
        return {
          fields: [
          {
            property: "playerId",
            label: "Player",
            description: "Player, example Kim the Ultimate.",
          },
          ],
        };
      },
    });
});
</script>

<template>
 <style include="iron-flex iron-flex-alignment">
  iron-image {
    border-radius: 50%;
    border: 2px solid green;
    width: 40px;
    height:40px;
  }

  paper-button.send {
    background-color: rgba(135, 206, 250, .5);
    color: darkslategrey;
    font-size: small;
    font-weight: bold;
  }

  .message-from-other {
    display: flex;
    justify-content: flex-start;
  }

  .message-from-me {
    display: flex;
    justify-content: flex-end;
  }

  .player-name {
    font-size: 10px;
  }

  .message-from-me .player-name {
    align-self: flex-end;
  }

  .message-from-other .player-name {
    align-self: flex-start;
  }

  .display-sender {}

  .hide-sender {}

  .message-from-me .display-avatar {
    order: 3;
  }

  .message-from-other .display-avatar {
    order: 1;
  }

  .display-sender .player-name {
    visibility: visible;
  }

  .display-sender .display-avatar {
    visibility: visible;
  }

  .hide-sender .player-name {
    display: none;
  }

  .hide-sender .display-avatar {
    visibility: hidden;
    height: 0px;
  }

  .display-message {
    align-self: center;
    order: 2;
  }

  .message-from-me .display-message {
    padding-right: 8px;
  }

  .message-from-other .display-message {
    padding-left: 8px;
  }

  .message-text {
    border-radius: 25px;
    margin-bottom: 4px;
    padding: 4px;
    padding-right: 8px;
    padding-left: 8px;
    white-space: pre;
  }

  .message-from-me .message-text {
    align-self: flex-end;
    background-color: rgba(135, 206, 250, .4);
  }

  .message-from-other .message-text {
    align-self: flex-start;
    background-color: lightgrey;
  }

  .textbox {
    padding-top: 8px;
  }

  .textbox-input-field {
    @apply(--layout-flex);
    padding-right: 16px;
  }
</style>
<paper-icon-button id="refresh" icon="icons:refresh" on-tap="refresh_">
</paper-icon-button>
<paper-icon-button id="add" icon="icons:add" on-tap="addPlayer_">
</paper-icon-button>
<ghvz-super-form
id="addPlayerForm"
type-name="Add Player"
blueprint="[[makeFormBlueprint_()]]">
</ghvz-super-form>
<!-- Display messages -->
<template is="dom-repeat" items="[[chatRoom.messages]]">
  <div class$="layout horizontal [[computeMessageDisplayClass_(item.playerId, currentPlayerId)]] [[displaySenderInfo(item.playerId)]]">
    <!-- Display message text -->
    <div class="layout vertical display-message">
      <div class="player-name">
        [[getName_(item.playerId)]]
      </div>
      <div class="message-text">[[item.message]]</div>
      <paper-tooltip position="top" animation-delay="0">
        [[getTime_(item.time)]]
      </paper-tooltip>
    </div>
    <!-- Display player avatar -->
    <div class="layout vertical display-avatar">
      <!-- Circular image style thanks to: https://jsfiddle.net/rvem3v8d/ -->
      <iron-image
      src="[[getProfilePic_(item.playerId)]]"
      id="profile-pic" 
      sizing="cover"
      on-click="openPlayerProfile_">
    </iron-image>
    <paper-tooltip position="top" animation-delay="0">
      [[getName_(item.playerId)]]
    </paper-tooltip>
  </div>
</div> 
</template>

<!-- Text Input -->
<div class="layout horizontal textbox">
  <paper-textarea 
  class="textbox-input-field"
  id="messageInput"
  autocorrect
  multiline
  max-rows=3
  label="message"
  no-label-float
  on-keydown="checkForEnter_">
</paper-textarea>
<paper-button 
class="send"
id="messageSend" 
raised
on-click="onSendClicked_">
SEND
</paper-button>
</div>
</template>
</dom-module>