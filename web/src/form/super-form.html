
<dom-module id="ghvz-super-form">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-super-form',

        properties: {
          blueprint: {
            type: Object,
          },

          typeName: {
            type: String,
            value: "",
          },

          editing: {
            type: String,
            value: null,
          },

          fields: {
            type: Object,
            value: [],
          },

          doneEnabled: {
            type: Boolean,
            value: true,
          },
        },

        observers: [
          'updateDoneEnabled_(fields.*)',
        ],

        attached: function() {
          this.resolveDonePromise = null;

          let fields = [];
          for (let field of this.blueprint.fields) {
            fields.push({
              index: fields.length,
              property: field.property,
              type: field.type || "string",
              label: field.label || "",
              required: field.required == null ? true : field.required,
              width: field.width || null,
              description: field.description || "",
              value: "",
            });
          }
          this.fields = fields;
        },

        getFieldIndexByProperty(property) {
          for (let i = 0; i < this.fields.length; i++) {
            if (this.fields[i].property == property) {
              return i;
            }
          }
          return null;
        },

        populate_(values) {
          for (let field of this.fields) {
            if (field.property in values) {
              this.set('fields.' + field.index + '.value', values[field.property]);
            } else {
              this.set('fields.' + field.index + '.value', "");
            }
          }
        },

        assembleValues_() {
          let values = {};
          for (let field of this.fields) {
            values[field.property] = field.value;
          }
          return values;
        },

        openForAdding: function(opt_initialValues) {
          this.editing = false;
          this.populate_(opt_initialValues || {});
          this.$.form.open();
          return new Promise((resolve, reject) => {
            this.resolveDonePromise = resolve;
          });
        },

        openForEditing: function(values) {
          this.editing = true;
          this.populate_(values);
          this.$.form.open();
          return new Promise((resolve, reject) => {
            this.resolveDonePromise = resolve;
          });
        },

        computeTitle_(editing, typeName) {
          return (editing ? "Edit " : "New ") + typeName;
        },

        done_: function() {
          this.resolveDonePromise(this.assembleValues_());
        },

        updateDoneEnabled_() {
          for (let field of this.fields) {
            if (field.required) {
              if (field.value == "" || field.value == null) {
                this.doneEnabled = false;
                return;
              }
            }
          }
          this.doneEnabled = true;
        },

        useTimestampPicker_: function(field) {
          return field.type == 'time' || field.type == 'timestamp';
        },

        usePaperTextarea_: function(field) {
          return field.type == 'text' || field.type == 'textarea' || field.type == 'paragraph';
        },

        usePaperCheckbox_: function(field) {
          return field.type == 'boolean' || field.type == 'checkbox';
        },

        usePaperInput_: function(field) {
          return !field.type || field.type == 'string';
        },
      });
    });
  </script>
  <template>
    <ghvz-form
        id="form"
        title="[[computeTitle_(editing, typeName)]]"
        close-label="Cancel"
        done-label="Done"
        done-enabled="[[doneEnabled]]"
        on-ghvz-form-done="done_">
      <template is="dom-repeat" items="{{fields}}" as="field">
        <ghvz-form-section
            section-width$="[[field.width]]"
            description="[[field.description]]">
          <template is="dom-if" if="[[useTimestampPicker_(field)]]">
            <ghvz-timestamp-picker timestamp="{{field.value}}">
            </ghvz-timestamp-picker>
          </template>
          <template is="dom-if" if="[[usePaperTextarea_(field)]]">
            <paper-textarea label="[[field.label]]" checked="{{field.value}}">
            </paper-textarea>
          </template>
          <template is="dom-if" if="[[usePaperCheckbox_(field)]]">
            <paper-checkbox checked="{{field.value}}">
              [[field.label]]
            </paper-checkbox>
          </template>
          <template is="dom-if" if="[[usePaperInput_(field)]]">
            <paper-input label="[[field.label]]" value="{{field.value}}">
            </paper-input>
          </template>
        </ghvz-form-section>
      </template>
      <content></content>
    </ghvz-form>
  </template>
</dom-module>
