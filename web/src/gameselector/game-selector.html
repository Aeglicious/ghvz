<dom-module id="ghvz-game-selector">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-game-selector',

        properties: {
          userId: {
            type: String,
          },

          user: {
            type: Object,
          },

          games: {
            type: Array,
          },

          gameId: {
            type: String,
            notify: true,
            value: null,
          },

          playerId: {
            type: String,
            notify: true,
            value: null,
          },
        },

        observers: [
          'autoChooseGame_(userId, user.*)',
        ],

        attached() {
          this.gameNumber = null;
        },

        setGameNumber(gameNumber) {
          this.gameNumber = gameNumber;
        },

        findGameWithNumber(number) {
          for (let game of this.games) {
            if (game.number == gameNumber) {
              return game;
            }
          }
          return null;
        },

        findUserPlayerInGame(gameId) {
          if (this.user && this.user.players) {
            for (let userPlayer of this.user.players) {
              if (userPlayer.gameId == gameId) {
                return userPlayer;
              }
            }
          }
          return null;
        },

        findFirstUserPlayer() {
          if (this.user && this.user.players) {
            for (let userPlayer of this.user.players) {
              return userPlayer;
            }
          }
          return null;
        },

        autoChooseGame_: function() {
          if (this.gameId == null && this.playerId == null) {
            if (this.gameNumber) {
              let game = this.findGameWithNumber(this.gameNumber);
              if (game) {
                this.gameId = game.id;
                this.$.gameChooser.selected = this.games.findIndex((game) => game.id == this.gameId);
                let userPlayer = this.findUserPlayerInGame(this.gameId);
                if (userPlayer) {
                  this.playerId = userPlayer.playerId;
                }
              }
            } else {
              let userPlayer = this.findFirstUserPlayer();
              if (userPlayer) {
                this.gameId = userPlayer.gameId;
                this.playerId = userPlayer.playerId;
                this.$.gameChooser.selected = this.games.findIndex((game) => game.id == this.gameId);
              }
            }
          }
        },

        chooseGame_: function(e) {
          let gameIndex = this.$.gameChooser.selected;
          this.gameId = this.games[gameIndex].id;
        },
      });
    });
  </script>
  <template>
    <paper-dropdown-menu label="Game">
      <paper-listbox id="gameChooser" class="dropdown-content" on-iron-select="chooseGame_">
        <template is="dom-repeat" items="[[games]]" as="game">
          <paper-item data-game-id$="[[game.id]]">[[game.name]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>
  </template>
</dom-module>
