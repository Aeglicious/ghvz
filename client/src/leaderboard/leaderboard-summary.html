
<dom-module id="leaderboard-summary">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
     Polymer({
      is: 'leaderboard-summary',

      properties: {
        serverBridge: Object,
        gameId: String,
        players: {
          type: Array,
          value: function() { return []; },
        },
        numToShow: {
          type: Number,
          value: 3,
        },
        pollInterval: {
          type: Number,
          value: 60,  // in seconds
        },
      },

      attached: function() {
        this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.refresh });
      },

      observers: [
      "ready_(serverBridge, gameId)",
      ],

      ready_: function(serverBridge, gameId) {
        serverBridge.findAllPlayersForGameId(gameId)
        .then((players) => {
          players.sort(Utils.byPoints);
          this.players = players.slice(0, this.numToShow);
        });

        setInterval(this.refresh_.bind(this), this.pollInterval * 1000);
      },

      makeTableBlueprint_: function() {
        return {
          columns: [
            {
              name: "Name",
              getModel: (player) => player.name,
              getValue: (player) => {
                var div = document.createElement('div');
                div.appendChild(document.createTextNode(player.name));
                var iconButton = document.createElement('paper-icon-button');
                iconButton.classList.add("player-icon");
                iconButton.icon = "icons:open-in-new";
                iconButton.dataset.playerId = player.id;
                div.appendChild(iconButton);
                this.scopeSubtree(div); // So we can style it from our <style>
                return div;
              },
            },
            {
              property: "points",
              name: "Points"
            },
          ],
          actions: [
            {
              action: "view",
              name: "View",
            },
            {
              action: "grr",
              name: "Grr",
            },
          ]
        };
      },

      refresh_: function() {
        this.serverBridge.findAllPlayersForGameId(this.gameId)
        .then((players) => {
          if (players) {
            players.sort(Utils.byPoints);
            this.players = players.slice(0, this.numToShow);
          }
        });
      },
    });
  });
 </script>
 <template>
  <style>
    auto-table {
      display: block;
    }
    .player-icon {
      opacity: .5;
    }
  </style>
  <paper-icon-button
  id="refresh"
  icon="icons:refresh"
  on-tap="refresh_">
</paper-icon-button>
<auto-table
id="leaderboardTable"
blueprint="[[makeTableBlueprint_()]]"
items="[[players]]">
</auto-table>
</template>
</dom-module>
