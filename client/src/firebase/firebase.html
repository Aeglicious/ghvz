<dom-module id="ghvz-firebase">
  <script>
  function throwError(...message) {
    console.error(...message);
    debugger;
    throw message;
  }
  function assert(condition, ...message) {
    if (!condition)
      throwError(...message);
    return condition;
  }
  function findIndexById(collection, id) {
    assert(collection, 'Bad arg');
    let index = collection.findIndex((obj) => (obj.id == id));
    assert(index >= 0, 'Not found!', collection, id);
    return index;
  }

    const GUN_PROPERTIES = ['number', 'playerId'];
    const GUN_COLLECTIONS = [];
    const GAME_PROPERTIES = ['name', 'rulesUrl', 'stunTimer'];
    const GAME_COLLECTIONS = [
      {arrayName: 'missions', mapName: 'missionsById'},
      {arrayName: 'rewardCategories', mapName: 'rewardCategoriesById'},
      {arrayName: 'chatRooms', mapName: 'chatRoomsById'},
      {arrayName: 'players', mapName: 'playersById'},
      {arrayName: 'adminUserIds'},
      {arrayName: 'notificationCategories', mapName: 'notificationCategoriesById'}
    ];
    const CHAT_ROOM_PROPERTIES = ['allegianceFilter', 'name'];
    const CHAT_ROOM_COLLECTIONS = [
      {arrayName: 'messages', mapName: 'messagesById'},
      {arrayName: 'memberships', mapName: 'membershipsById'},
    ];
    const CHAT_ROOM_MEMBERSHIP_PROPERTIES = ['playerId'];
    const CHAT_ROOM_MEMBERSHIP_COLLECTIONS = [];
    const CHAT_ROOM_MESSAGE_PROPERTIES = ['index', 'message', 'playerId', 'time'];
    const CHAT_ROOM_MESSAGE_COLLECTIONS = [];
    const MISSION_PROPERTIES = ['name', 'beginTime', 'endTime', 'url', 'allegianceFilter'];
    const MISSION_COLLECTIONS = [];
    const NOTIFICATION_CATEGORY_PROPERTIES = ['name'];
    const NOTIFICATION_CATEGORY_COLLECTIONS = [];
    const PLAYER_PROPERTIES = ['userId', 'number', 'allegiance', 'infectable', 'name', 'needGun', 'points', 'profileImageUrl', 'startAsZombie', 'volunteer'];
    const PLAYER_COLLECTIONS = [
      {arrayName: 'infections'},
      {arrayName: 'lives'},
      {arrayName: 'rewards'},
      {arrayName: 'notifications'},
    ];
    const PLAYER_REWARD_PROPERTIES = ['time', 'rewardId', 'rewardCategoryId'];
    const PLAYER_REWARD_COLLECTIONS = [];
    const PLAYER_LIFE_PROPERTIES = ['time', 'code'];
    const PLAYER_LIFE_COLLECTIONS = [];
    const PLAYER_INFECTION_PROPERTIES = ['time', 'infectorId'];
    const PLAYER_INFECTION_COLLECTIONS = [];
    const PLAYER_NOTIFICATION_PROPERTIES = ['message', 'previewMessage', 'notificationCategoryId', 'seenTime', 'sendTime', 'sound', 'vibrate'];
    const PLAYER_NOTIFICATION_COLLECTIONS = [];
    const REWARD_CATEGORY_PROPERTIES = ['name', 'points', 'seed', 'claimed'];
    const REWARD_CATEGORY_COLLECTIONS = [
      {arrayName: 'rewards', mapName: 'rewardsById'}
    ];
    const REWARD_CATEGORY_REWARD_PROPERTIES = ['playerId', 'code'];
    const REWARD_CATEGORY_REWARD_COLLECTIONS = [];

    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-firebase',

        properties: {
          firebaseUser: {
            type: Object,
            value: null,
          },

          userId: {
            type: String,
            computed: 'computeUserId_(firebaseUser)',
            observer: 'onUserIdChanged_',
            notify: true,
          },

          firebaseRoot: {
            type: Object,
            computed: 'computeFirebaseRoot_(firebaseUser)',
          },

          gameId: {
            type: String,
            value: null,
            observer: 'onGameIdChanged_',
            notify: true,
          },

          playerId: {
            type: String,
            value: null,
            observer: 'onPlayerIdChanged_',
            notify: true,
          },

          target: {
            type: Object,
            value: null,
          },
        },

        computeUserId_: function(firebaseUser) {
          return firebaseUser && firebaseUser.uid;
        },

        computeFirebaseRoot_: function(firebaseUser) {
          return this.$.app.app.database().ref();
        },

        getGunIndex_: function(id) { return findIndexById(this.target.get("guns"), id); },
        getGameIndex_: function(id) { return findIndexById(this.target.get("games"), id); },
        getNotificationCategoryIndex_: function(id) { return findIndexById(this.target.get("game.notificationCategories"), id); },
        getRewardCategoryIndex_: function(id) { return findIndexById(this.target.get("game.rewardCategories"), id); },
        getRewardCategoryRewardIndex_: function(rewardCategoryId, rewardCategoryRewardId) { return findIndexById(this.target.get("game.rewardCategoriesById." + rewardCategoryId).rewards, rewardCategoryRewardId); },
        getMissionIndex_: function(id) { return findIndexById(this.target.get("game.missions"), id); },
        getChatRoomIndex_: function(id) { return findIndexById(this.target.get("game.chatRooms"), id); },
        getPlayerIndex_: function(id) {
          if (!this.target.get("game") || !this.target.get("game.players")) {
            debugger;
          }
          return findIndexById(this.target.get("game.players"), id);
        },
        getPlayerRewardIndex_: function(playerId, playerRewardId) { return findIndexById(this.target.get("game.playersById." + playerId).rewards, playerRewardId); },
        getPlayerLifeIndex_: function(playerId, playerLifeId) { return findIndexById(this.target.get("game.playersById." + playerId).lives, playerLifeId); },
        getPlayerInfectionIndex_: function(playerId, playerInfectionId) { return findIndexById(this.target.get("game.playersById." + playerId).infections, playerInfectionId); },
        getPlayerNotificationIndex_: function(playerId, playerNotificationId) {
          return findIndexById(this.target.get("game.playersById." + playerId).notifications, playerNotificationId);
        },
        getChatRoomMembershipIndex_: function(chatRoomId, chatRoomMembershipId) {
          return findIndexById(this.target.get("game.chatRoomsById." + chatRoomId).memberships, chatRoomMembershipId);
        },
        getChatRoomMessageIndex_: function(chatRoomId, chatRoomMessageId) {
          return findIndexById(this.target.get("game.chatRoomsById." + chatRoomId).messages, chatRoomMessageId);
        },

        listenForPropertyChanges_: function(collectionRef, properties, collections, setCallback) {
          collectionRef.on('child_added', (change) => {
            if (properties.includes(change.getKey())) {
              setCallback(change.getKey(), change.val());
            } else if (collections.find((col) => col.arrayName == change.getKey())) {
              setCallback(change.getKey(), []);
            } else {
              throwError('Unexpected!', change.val(), change.getKey(), arguments);
            }
          });
          collectionRef.on('child_changed', (change) => {
            if (properties.includes(change.getKey())) {
              setCallback(change.getKey(), change.val());
            } else if (collections.find((col) => col.arrayName == change.getKey())) {
              // do nothing, covered elsewhere
            } else {
              throwError('Unexpected!', change.val(), change.getKey(), arguments);
            }
          });
          collectionRef.on('child_removed', (change) => {
            if (properties.includes(change.getKey())) {
              setCallback(change.getKey(), null);
            } else if (collections.find((col) => col.arrayName == change.getKey())) {
              setCallback(change.getKey(), []);
            } else {
              throwError('Unexpected!', change.val(), change.getKey(), arguments);
            }
          });
        },

        setupClientSideObject(id, snapshot, propertyNames, lists) {
          let obj = {id: id};
          let snapshotValue = snapshot.val();
          for (let propertyName of propertyNames) {
            obj[propertyName] = snapshotValue[propertyName] || null;
          }
          for (let {arrayName, mapName} of lists) {
            obj[arrayName] = [];
            obj[mapName] = {};
          }
          return obj;
        },

        shallowListenToGames: function() {
          this.firebaseRoot.child('games').on('child_added', (snap) => {
            let gameId = snap.getKey();
            let obj = this.setupClientSideObject(gameId, snap, GUN_PROPERTIES, GUN_COLLECTIONS);
            this.target.push('games', obj);
            this.target.set('gamesById. ' + gameId, obj);
            this.listenForPropertyChanges_(
                snap.ref, GAME_PROPERTIES, GAME_COLLECTIONS,
                (property, value) => {
                  this.target.set('games.' + this.getGameIndex_(gameId) + '.' + property, value);
                });
          });
          this.firebaseRoot.child('games').on('child_removed', (snap) => {
            this.splice('games', this.getGameIndex_(snap.getKey()), 1);
            delete this.target.get('gamesById')[snap.getKey()];
          });
        },

        listenToGuns: function() {
          this.firebaseRoot.child('guns').on('child_added', (snap) => {
            let gunId = snap.getKey();
            let obj = this.setupClientSideObject(gunId, snap, GUN_PROPERTIES, GUN_COLLECTIONS);
            this.target.push('guns', obj);
            this.target.set('gunsById.' + gunId, obj);
            this.listenForPropertyChanges_(
                snap.ref, GUN_PROPERTIES, GUN_COLLECTIONS,
                (property, value) => {
                  this.target.set('guns.' + this.getGunIndex_(gunId) + '.' + property, value);
                });
          });
        },

        listenToMissions_: function(gameId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/missions');
          ref.on('child_added', (snap) => {
            let missionId = snap.getKey();
            let obj = this.setupClientSideObject(missionId, snap, MISSION_PROPERTIES, MISSION_COLLECTIONS);
            this.target.push('game.missions', obj);
            this.target.set('game.missionsById.' + missionId, obj);
            this.listenForPropertyChanges_(
                snap.ref, MISSION_PROPERTIES, MISSION_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.missions.' + this.getMissionIndex_(missionId) + '.' + property, value);
                });
          });
        },

        listenToChatRooms_: function(gameId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/chatRooms');
          ref.on('child_added', (snap) => {
            let chatRoomId = snap.getKey();
            let obj = this.setupClientSideObject(chatRoomId, snap, CHAT_ROOM_PROPERTIES, CHAT_ROOM_COLLECTIONS);
            this.target.push('game.chatRooms', obj);
            this.target.set('game.chatRoomsById.' + chatRoomId, obj);
            this.listenForPropertyChanges_(
                snap.ref, CHAT_ROOM_PROPERTIES, CHAT_ROOM_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.chatRooms.' + this.getChatRoomIndex_(chatRoomId) + '.' + property, value);
                });
            this.listenToChatRoomMemberships_(gameId, chatRoomId);
            this.listenToChatRoomMessages_(gameId, chatRoomId);
          });
        },

        listenToChatRoomMemberships_: function(gameId, chatRoomId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/chatRooms/' + chatRoomId + '/memberships');
          ref.on('child_added', (snap) => {
            let chatRoomMembershipId = snap.getKey();
            let obj = this.setupClientSideObject(chatRoomMembershipId, snap, CHAT_ROOM_MEMBERSHIP_PROPERTIES, CHAT_ROOM_MEMBERSHIP_COLLECTIONS);
            this.target.push('game.chatRooms.' + this.getChatRoomIndex_(chatRoomId) + '.memberships', obj);
            this.target.set('game.chatRooms.' + this.getChatRoomIndex_(chatRoomId) + '.memberships.' + chatRoomMembershipId, obj);
            this.listenForPropertyChanges_(
                snap.ref, CHAT_ROOM_MEMBERSHIP_PROPERTIES, CHAT_ROOM_MEMBERSHIP_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.chatRooms.' + this.getChatRoomIndex_(chatRoomId) + '.memberships.' + this.getChatRoomMembershipIndex_(chatRoomId, chatRoomMembershipId) + '.' + property, value);
                });
          });
        },

        listenToChatRoomMessages_: function(gameId, chatRoomId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/chatRooms/' + chatRoomId + '/messages');
          ref.on('child_added', (snap) => {
            let chatRoomMessageId = snap.getKey();
            let obj = this.setupClientSideObject(chatRoomMessageId, snap, CHAT_ROOM_MESSAGE_PROPERTIES, CHAT_ROOM_MESSAGE_COLLECTIONS);
            this.target.push('game.chatRooms.' + this.getChatRoomIndex_(chatRoomId) + '.messages', obj);
            this.target.set('game.chatRooms.' + this.getChatRoomIndex_(chatRoomId) + '.messages.' + chatRoomMessageId, obj);
            this.listenForPropertyChanges_(
                snap.ref, CHAT_ROOM_MESSAGE_PROPERTIES, CHAT_ROOM_MESSAGE_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.chatRooms.' + this.getChatRoomIndex_(chatRoomId) + '.messages.' + this.getChatRoomMessageIndex_(chatRoomId, chatRoomMessageId) + '.' + property, value);
                });
          });
        },

        listenToPlayers_: function(gameId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/players');
          ref.on('child_added', (snap) => {
            let playerId = snap.getKey();
            let obj = this.setupClientSideObject(playerId, snap, PLAYER_PROPERTIES, PLAYER_COLLECTIONS);
            this.target.push('game.players', obj);
            this.target.set('game.playersById.' + playerId, obj);
            this.listenForPropertyChanges_(
                snap.ref, PLAYER_PROPERTIES, PLAYER_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.players.' + this.getPlayerIndex_(playerId) + '.' + property, value);
                });
            this.listenToPlayerRewards_(gameId, playerId);
            this.listenToPlayerLives_(gameId, playerId);
            this.listenToPlayerInfections_(gameId, playerId);
            this.listenToPlayerNotifications_(gameId, playerId);
          });
        },

        listenToPlayerRewards_: function(gameId, playerId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/players/' + playerId + '/rewards');
          ref.on('child_added', (snap) => {
            let playerRewardId = snap.getKey();
            let obj = this.setupClientSideObject(playerRewardId, snap, PLAYER_REWARD_PROPERTIES, PLAYER_REWARD_COLLECTIONS);
            this.target.push('game.players.' + this.getPlayerIndex_(playerId) + '.rewards', obj);
            this.listenForPropertyChanges_(
                snap.ref, PLAYER_REWARD_PROPERTIES, PLAYER_REWARD_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.players.' + this.getPlayerIndex_(playerId) + '.rewards.' + this.getPlayerRewardIndex_(playerId, playerRewardId) + '.' + property, value);
                });
          });
        },

        listenToPlayerLives_: function(gameId, playerId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/players/' + playerId + '/lives');
          ref.on('child_added', (snap) => {
            let playerLifeId = snap.getKey();
            let obj = this.setupClientSideObject(playerLifeId, snap, PLAYER_LIFE_PROPERTIES, PLAYER_LIFE_COLLECTIONS);
            this.target.push('game.players.' + this.getPlayerIndex_(playerId) + '.lives', obj);
            this.target.set('game.players.' + this.getPlayerIndex_(playerId) + '.lives.' + playerLifeId, obj);
            this.listenForPropertyChanges_(
                snap.ref, PLAYER_LIFE_PROPERTIES, PLAYER_LIFE_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.players.' + this.getPlayerIndex_(playerId) + '.lives.' + this.getPlayerLifeIndex_(playerId, playerLifeId) + '.' + property, value);
                });
          });
        },

        listenToPlayerInfections_: function(gameId, playerId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/players/' + playerId + '/infections');
          ref.on('child_added', (snap) => {
            let playerInfectionId = snap.getKey();
            let obj = this.setupClientSideObject(playerInfectionId, snap, PLAYER_INFECTION_PROPERTIES, PLAYER_INFECTION_COLLECTIONS);
            this.target.push('game.players.' + this.getPlayerIndex_(playerId) + '.infections', obj);
            this.target.set('game.players.' + this.getPlayerIndex_(playerId) + '.infections.' + playerInfectionId, obj);
            this.listenForPropertyChanges_(
                snap.ref, PLAYER_INFECTION_PROPERTIES, PLAYER_INFECTION_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.players.' + this.getPlayerIndex_(playerId) + '.infections.' + this.getPlayerInfectionIndex_(playerId, playerInfectionId) + '.' + property, value);
                });
          });
        },

        listenToPlayerNotifications_: function(gameId, playerId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/players/' + playerId + '/notifications');
          ref.on('child_added', (snap) => {
            let playerNotificationId = snap.getKey();
            let obj = this.setupClientSideObject(playerNotificationId, snap, PLAYER_NOTIFICATION_PROPERTIES, PLAYER_NOTIFICATION_COLLECTIONS);
            this.target.push('game.players.' + this.getPlayerIndex_(playerId) + '.notifications', obj);
            this.target.set('game.players.' + this.getPlayerIndex_(playerId) + '.notifications.' + playerNotificationId, obj);
            this.listenForPropertyChanges_(
                snap.ref, PLAYER_NOTIFICATION_PROPERTIES, PLAYER_NOTIFICATION_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.players.' + this.getPlayerIndex_(playerId) + '.notifications.' + this.getPlayerNotificationIndex_(playerId, playerNotificationId) + '.' + property, value);
                });
          });
        },

        listenToNotificationCategories_: function(gameId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/notificationCategories');
          ref.on('child_added', (snap) => {
            let notificationCategoryId = snap.getKey();
            let obj = this.setupClientSideObject(notificationCategoryId, snap, NOTIFICATION_CATEGORY_PROPERTIES, NOTIFICATION_CATEGORY_COLLECTIONS);
            this.target.push('game.notificationCategories', obj);
            this.target.set('game.notificationCategoriesById.' + notificationCategoryId, obj);
            this.listenForPropertyChanges_(
                snap.ref, NOTIFICATION_CATEGORY_PROPERTIES, NOTIFICATION_CATEGORY_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.notificationCategories.' + this.getNotificationCategoryIndex_(notificationCategoryId) + '.' + property, value);
                });
          });
        },

        listenToRewardCategories_: function(gameId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/rewardCategories');
          ref.on('child_added', (snap) => {
            let rewardCategoryId = snap.getKey();
            let obj = this.setupClientSideObject(rewardCategoryId, snap, REWARD_CATEGORY_PROPERTIES, REWARD_CATEGORY_COLLECTIONS);
            this.target.push('game.rewardCategories', obj);
            this.target.set('game.rewardCategoriesById.' + rewardCategoryId, obj);
            this.listenForPropertyChanges_(
                snap.ref, REWARD_CATEGORY_PROPERTIES, REWARD_CATEGORY_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.rewardCategories.' + this.getRewardCategoryIndex_(rewardCategoryId) + '.' + property, value);
                });
            this.listenToRewardCategoryRewards_(gameId, rewardCategoryId);
          });
        },

        listenToRewardCategoryRewards_: function(gameId, rewardCategoryId) {
          var ref = this.firebaseRoot.child('games/' + gameId + '/rewardCategories/' + rewardCategoryId + '/rewards');
          ref.on('child_added', (snap) => {
            let rewardCategoryRewardId = snap.getKey();
            let obj = this.setupClientSideObject(rewardCategoryRewardId, snap, REWARD_CATEGORY_REWARD_PROPERTIES, REWARD_CATEGORY_REWARD_COLLECTIONS);
            this.target.push('game.rewardCategories.' + this.getRewardCategoryIndex_(rewardCategoryId) + '.rewards', obj);
            this.target.set('game.rewardCategories.' + this.getRewardCategoryIndex_(rewardCategoryId) + '.rewards.' + rewardCategoryRewardId, obj);
            this.listenForPropertyChanges_(
                snap.ref, REWARD_CATEGORY_REWARD_PROPERTIES, REWARD_CATEGORY_REWARD_COLLECTIONS,
                (property, value) => {
                  this.target.set('game.rewardCategories.' + this.getRewardCategoryIndex_(rewardCategoryId) + '.rewards.' + this.getRewardCategoryRewardIndex_(rewardCategoryId, rewardCategoryRewardId) + '.' + property, value);
                });
          });
        },

        listenToSpecificGame: function(gameId) {
          this.firebaseRoot.child('games').on('child_added', (snap) => {
            if (snap.getKey() == gameId) {
              let obj = this.setupClientSideObject(gameId, snap, GAME_PROPERTIES, GAME_COLLECTIONS);
              this.target.set('game', obj);
              this.listenForPropertyChanges_(
                  snap.ref, GAME_PROPERTIES, GAME_COLLECTIONS,
                  (property, value) => {
                    this.target.set('game.' + property, value);
                  });
              this.listenToMissions_(gameId);
              this.listenToChatRooms_(gameId);
              this.listenToPlayers_(gameId);
              this.listenToRewardCategories_(gameId);
              this.listenToNotificationCategories_(gameId);
            }
          });
        },

        onUserIdChanged_: function(userId, oldUserId) {
          if (userId && oldUserId) {
            throw 'Cannot user player once selected, must refresh!';
          }
          if (userId) {
            this.firebaseRoot.child('users/' + userId + '/players').on('child_added', (snap) => {
              if (!this.target.get("gameId") && !this.playerId) {
                let gameId = snap.val().gameId;
                let playerId = snap.val().playerId;
                this.gameId = gameId;
                this.playerId = playerId;
              }
            });
            this.shallowListenToGames();
            this.listenToGuns();
          }
        },

        onGameIdChanged_: function(gameId, oldGameId) {
          // So we know we're not inside our firebase code
          this.async(() => {
            if (gameId && oldGameId) {
              throw 'Cannot change player once selected, must refresh!';
            }
            if (gameId) {
              this.listenToSpecificGame(gameId);
            }
          });
        },

        onPlayerIdChanged_: function(playerId, oldPlayerId) {
          if (playerId && oldPlayerId) {
            throw 'Cannot change player once selected, must refresh!';
          }
        },

        signIn: function() {
          this.$.auth.signInWithPopup();
        },
      });
    });
  </script>
  <template>
    <firebase-app
        id="app"
        name="GoogleHvZ"
        auth-domain="zeds-dbe0f.firebaseapp.com"
        database-url="https://zeds-dbe0f.firebaseio.com"
        api-key="AIzaSyCH6Z73pymnu8lzn8b5-O8yuf2FrOt8GOs"
        storage-bucket="zeds-dbe0f.appspot.com"
        messaging-sender-id="721599614458">
    </firebase-app>
    <firebase-auth
        id="auth"
        app-name="GoogleHvZ"
        user="{{firebaseUser}}"
        provider="google"
        on-error="handleError_">
    </firebase-auth>
  </template>
</dom-module>
