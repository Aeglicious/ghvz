
<dom-module id="ghvz-desktop-app">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-desktop-app',

        properties: {
          serverBridge: {
            type: Object,
            value: makeFakePrepopulatedServerBridge(),
          },

          chatRoomIds: {
            type: Array,
            value: undefined,
          },

          userId: {
            type: String,
          },

          games: {
            type: Array,
          },

          gameId: {
            type: String,
            notify: true,
          },

          game: {
            type: Object,
          },

          playerId: {
            type: String,
            notify: true,
          },

          isAdmin: {
            type: Boolean,
            value: true,
          },

          isZombie: {
            type: Boolean,
            value: true,
          },
        },

        attached: function() {
          // this.serverBridge.logIn('firstuserauthcode')
          //     .then((userId) => {
          //       this.userId = userId;
          //       return this.serverBridge.findAllPlayerIdsForUserId(this.userId);
          //     })
          //     .then((playerIds) => {
          //       if (playerIds.length == 0) {
          //         alert('you should join a game');
          //       } else if (playerIds.length == 1) {
          //         this.playerId = playerIds[0];
          //         this.serverBridge.findAllChatRoomIdsForPlayerId(this.playerId)
          //             .then((chatRoomIds) => {
          //               this.chatRoomIds = chatRoomIds;
          //             });
          //         this.serverBridge.getPlayerById(this.playerId)
          //             .then((player) => {
          //               this.gameId = player.gameId;
          //             });
          //       } else {
          //         alert('you should somehow choose a game');
          //       }
          //     });
        },

        becomeAdmin_: function() {
          this.isAdmin = true;
        },

        becomeNotAdmin_: function() {
          this.isAdmin = false;
        },

        handleError_: function(e) {
          debugger;
        },

        chooseGame_: function(e) {
          let gameIndex = this.$$("#gameChooser").selected;
          this.gameId = this.games[gameIndex].id;
        },

        computeShowRegister_(gameId, playerId) {
          return gameId && !playerId;
        },
      });
    });
  </script>
  <template>
  	<style>
      :host {
        display: block;
        position: relative;
        background-color: #f4f4f4;
      }
      .content {
        display: block;
        margin: 16px;
      }
      #viewControls paper-checkbox {
        margin-left: 16px;
      }
      #topControls {
        display: flex;
        justify-content: space-between;
        padding: 0 16px;
        align-items: center;
      }
      .info {
        text-align: center;
      }
  	</style>

    <div id="topControls">

      <paper-dropdown-menu label="Game">
        <paper-listbox id="gameChooser" class="dropdown-content" on-iron-select="chooseGame_">
          <template is="dom-repeat" items="[[games]]" as="game">
            <paper-item data-game-id$="[[game.id]]">[[game.name]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>

      <div id="confidential">
        DONT POST CONFIDENTIAL INFO, COBFLABBIT!
      </div>

      <div class="info">
        userId [[userId]]
      </div>

      <div class="info">
        gameId [[gameId]]
      </div>

      <div class="info">
        playerId [[playerId]]
      </div>

      <div id="viewControls">
        <paper-checkbox checked="{{isAdmin}}">Is Admin</paper-checkbox>
        <paper-checkbox checked="{{isZombie}}">Is Zombie</paper-checkbox>
      </div>
    </div>

    <ghvz-dashboard>
      <template is="dom-if" if="[[computeShowRegister_(gameId, playerId)]]">
        <ghvz-dashlet scrolling full>
          <div class="header">Join A Game</div>
          <game-registration
                class="content"
                server-bridge="[[serverBridge]]"
                game-id="[[gameId]]"
                user-id="[[userId]]">
          </game-registration>
        </ghvz-dashlet>
      </template>

      <template is="dom-if" if="[[isAdmin]]">
        <template is="dom-if" if="[[gameId]]">
          <ghvz-dashlet admin full>
            <div class="header">Missions</div>
            <ghvz-missions
                server-bridge="[[serverBridge]]"
                game-id="[[gameId]]"
                missions="[[game.missions]]">
            </ghvz-missions>
          </ghvz-dashlet>

          <ghvz-dashlet scrolling admin full>
            <div class="header">Players</div>
            <player-table
                id="playerTableModule"
                server-bridge="[[serverBridge]]"
                reward-categories-by-id="[[game.rewardCategoriesById]]"
                players="[[game.players]]"
                players-by-id="[[game.playersById]]"
                game-id="[[gameId]]"
                current-user-id="[[userId]]">
            </player-table>
          </ghvz-dashlet>
          
          <ghvz-dashlet admin half left>
            <div class="header">Dev Tools</div>
            <dev-tools
                class="content"
                server-bridge="[[serverBridge]]"
                game-id="[[gameId]]"
                user-id="[[userId]]">
            </dev-tools>
          </ghvz-dashlet>

          <ghvz-dashlet scrolling admin half right>
            <div class="header">Guns</div>
            <ghvz-guns
                server-bridge="[[serverBridge]]"
                game-id="[[gameId]]"
                guns="[[guns]]"
                players="[[game.players]]"
                players-by-id="[[game.playersById]]">
            </ghvz-guns>
          </ghvz-dashlet>

       <ghvz-dashlet scrolling admin half right>
            <div class="header">Rewards</div>
            <ghvz-rewards
                server-bridge="[[serverBridge]]"
                players-by-id="[[game.playersById]]"
                reward-categories="[[game.rewardCategories]]"
                reward-categories-by-id="[[game.rewardCategoriesById]]">
            </ghvz-rewards>
          </ghvz-dashlet>
        </template>
      </template>

      <template is="dom-if" if="[[playerId]]">

        <template is="dom-if" if="[[isZombie]]">
          <ghvz-dashlet half left>
            <div class="header">Infect</div>
            <ghvz-infect
                server-bridge="[[serverBridge]]"
                game-id="[[gameId]]"
                player-id="[[playerId]]">
            </ghvz-infect>
          </ghvz-dashlet>
        </template>


        <ghvz-dashlet half left>
          <div class="header">Next Mission</div>
          <ghvz-next-mission
              server-bridge="[[serverBridge]]"
              missions="[[game.missions]]"
              game-id="[[gameId]]"
              player-id="[[playerId]]">
          </ghvz-next-mission>
        </ghvz-dashlet>

        <ghvz-dashlet half right>
          <div class="header">Leaderboard</div>
          <leaderboard-summary players="[[game.players]]">
          </leaderboard-summary>
        </ghvz-dashlet>

        <ghvz-dashlet half right>
          <div class="header">Game Stats</div>
          <game-stat-summary>
          </game-stat-summary>
        </ghvz-dashlet>

        <ghvz-dashlet half left>
          <div class="header">Rewards</div>
          <ghvz-claim-reward
              server-bridge="[[serverBridge]]"
              game-id="[[gameId]]"
              player-id="[[playerId]]">
          </ghvz-claim-reward>
        </ghvz-dashlet>

        <template is="dom-repeat" items="[[game.chatRooms]]" as="chatRoom">
          <ghvz-dashlet half right>
            <div class="header">[[chatRoom.name]]</div>
            <chat-app
                class="content"
                server-bridge="[[serverBridge]]"
                game-id="[[gameId]]"
                players-by-id="[[game.playersById]]"
                chat-room="[[chatRoom]]"
                current-player-id="[[playerId]]">
            </chat-app>
          </ghvz-dashlet>
        </template>
      </template>

    </ghvz-dashboard>
  </template>
</dom-module>
